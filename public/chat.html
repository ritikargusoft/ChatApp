<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - SocketChat</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
        height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .chat-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .chat-header {
        background-color: #0d6efd;
        color: white;
        padding: 15px 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #f9f9f9;
      }
      .message {
        max-width: 75%;
        margin-bottom: 15px;
        clear: both;
      }
      .message.sent {
        float: right;
      }
      .message.received {
        float: left;
      }
      .message-bubble {
        padding: 12px 15px;
        border-radius: 18px;
        position: relative;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .message.sent .message-bubble {
        background-color: #0d6efd;
        color: white;
        border-bottom-right-radius: 5px;
      }
      .message.received .message-bubble {
        background-color: white;
        color: #333;
        border-bottom-left-radius: 5px;
        border: 1px solid #e9ecef;
      }
      .message-time {
        font-size: 0.7rem;
        margin-top: 5px;
        opacity: 0.8;
      }
      .message-input {
        background-color: white;
        border-top: 1px solid #dee2e6;
        padding: 15px 20px;
      }
      .back-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }
      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }
      .messages-container::-webkit-scrollbar {
        width: 6px;
      }
      .messages-container::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .messages-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }
      .messages-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <div class="d-flex align-items-center">
          <button
            class="back-btn me-3"
            onclick="window.location.href='convo.html'"
          >
            <i class="fas fa-arrow-left"></i>
          </button>
          <div>
            <h4 id="chatTitle" class="mb-0">Chat</h4>
            <small id="chatStatus" class="opacity-75">Active now</small>
          </div>
        </div>
      </div>

      <div class="messages-container" id="messages">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading messages...</p>
        </div>
      </div>

      <div class="message-input">
        <form id="sendForm" class="d-flex">
          <input
            type="text"
            id="messageInput"
            class="form-control me-2"
            placeholder="Type your message..."
          />
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const token = localStorage.getItem("token");
      const convoId = localStorage.getItem("activeConversation");
      const userId = localStorage.getItem("userId");

      if (!token || !convoId) {
        window.location.href = "login.html";
      }

      const socket = io("http://localhost:3000", {
        auth: { token },
      });

      socket.on("connect", () => {
        console.log(
          "Socket connected successfully. Joining conversation room."
        );
        socket.emit("Joined convo", convoId);
        loadHistory();
      });

      socket.on("message_created", addMessage);

      async function loadHistory() {
        try {
          const res = await fetch(`/message/${convoId}`, {
            headers: { Authorization: `${token}` },
          });
          const data = await res.json();
          const messagesContainer = document.getElementById("messages");
          messagesContainer.innerHTML = "";

          if (data.data && data.data.length > 0) {
            data.data.forEach(addMessage);
          } else {
            messagesContainer.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No messages yet</p>
                            <p class="text-muted">Send a message to start the conversation</p>
                        </div>
                    `;
          }

          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } catch (error) {
          console.error("Failed to load message history:", error);
        }
      }

      function addMessage(msg) {
        const messagesContainer = document.getElementById("messages");

        if (messagesContainer.querySelector(".text-center")) {
          messagesContainer.innerHTML = "";
        }

        const messageElement = document.createElement("div");
        messageElement.className = `message ${
          msg.sender_id == userId ? "sent" : "received"
        }`;

        const messageTime = new Date(msg.created_at).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        messageElement.innerHTML = `
                <div class="message-bubble">
                    <div class="message-text">${msg.message_content}</div>
                    <div class="message-time">${messageTime}</div>
                </div>
            `;

        messagesContainer.appendChild(messageElement);

        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      document.getElementById("sendForm").addEventListener("submit", (e) => {
        e.preventDefault();

        const input = document.getElementById("messageInput");
        const text = input.value.trim();

        if (!text) return;

        socket.emit("send_message", {
          conversation_id: convoId,
          sender_id: userId,
          message_content: text,
        });

        input.value = "";
      });

      document.getElementById(
        "chatTitle"
      ).textContent = `Conversation ${convoId}`;
    </script>
  </body>
</html>
